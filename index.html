<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Experiment</title>
  <!-- viewport setup -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- lab.js library and experiment code -->
  <!-- lab.js library code -->
  <script src="lib/lab.js" data-labjs-script="library"></script>
  <script src="lib/lab.fallback.js" data-labjs-script="fallback"></script>
  <link rel="stylesheet" href="lib/lab.css">
  <!-- study code and styles -->
  <script src="script.js" defer="true"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- If you'd rather have a container with a fixed width
       and variable height, try removing the fullscreen class below -->
  <div class="container fullscreen" data-labjs-section="main">
    <main class="content-vertical-center content-horizontal-center">
      <div>
        <h2>Loading Experiment</h2>
        <p>The experiment is loading and should start in a few seconds</p>
      </div>
    </main>
  </div>


<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxloi-Zqdkg_PTBcSAwywgEBJaidsfEzc-X7yhJtXBSSTZyQUXJOYPVmOgbGX869bD8/exec';

  function newParticipantId() {
    let pid = localStorage.getItem('pid');
    if (!pid) {
      pid = Math.random().toString(36).slice(2, 10);
      localStorage.setItem('pid', pid);
    }
    return pid;
  }

  // Detect whether this form submit actually contains your survey answers
  function hasSurveyData(row) {
    return Object.keys(row).some((k) =>
      /^rate_\d+$/.test(k) || /^pick_\d+$/.test(k)
    );
  }

  document.addEventListener('submit', async (event) => {
    const form = event.target;
    if (!(form instanceof HTMLFormElement)) return;

    // Read form data first
    const formData = new FormData(form);
    const row = Object.fromEntries(formData.entries());

    // If this submit doesn't look like your survey (no rate_x / pick_x),
    // don't touch it â€” let the browser / lab.js handle it normally.
    if (!hasSurveyData(row)) {
      return;
    }

    // This *is* the final survey submit: handle it ourselves.
    event.preventDefault();
    event.stopPropagation();

    const submitter = document.activeElement;
    if (submitter && typeof submitter.disabled === 'boolean') {
      submitter.disabled = true;
    }

    const payload = new URLSearchParams();
    payload.set('participantId', newParticipantId());
    payload.set('rows', JSON.stringify([row]));

    try {
      await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: payload.toString()
      });

      // On success: go to thank-you page
      window.location.href = '/thanks.html';
    } catch (err) {
      console.error('Upload failed:', err);
      if (submitter) submitter.disabled = false;
      alert('There was a problem submitting your responses. Please check your connection and click Submit again.');
    }
  }, true);
</script>

</body>
</html>
